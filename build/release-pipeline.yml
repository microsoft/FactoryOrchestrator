#Multi-configuration and multi-agent job options are not exported to YAML. Configure these options using documentation guidance: https://docs.microsoft.com/vsts/pipelines/process/phases
trigger:
  tags:
    include:
    - OSBuild*

resources:
  repositories:
  - repository: ComplianceRepo
    type: github
    endpoint: microsoft
    name: PowerShell/Compliance
    ref: master

variables:
  ${{ if or(startsWith(variables['Build.SourceBranchName'], 'OSBuild'), eq(variables['Build.SourceBranchName'], 'main')) }}:
    VERSIONSUFFIX: ''
    VERSIONSUFFIXVPACK: ''
    VERSIONSUFFIXDOTNET: ' '
    SKIPSIGNING: 'false'
    SKIPPUSH: 'false'
  ${{ if not(or(startsWith(variables['Build.SourceBranchName'], 'OSBuild'), eq(variables['Build.SourceBranchName'], 'main'))) }}:
    VERSIONSUFFIX: '$(Build.SourceBranchName)'
    VERSIONSUFFIXVPACK: '-$(Build.SourceBranchName)'
    VERSIONSUFFIXDOTNET: '--version-suffix $(Build.SourceBranchName)'
    SKIPSIGNING: 'true'
    SKIPPUSH: 'true'

name: $(BuildDefinitionName)_$(date:yyMM).$(date:dd)$(rev:rrr)

stages:
  - stage: 'Build_Test_FactoryOrchestrator_Windows'
    pool:
      name: "Hosted Windows 2019 with VS2019"
      demands:
      - msbuild
      - visualstudio

    jobs:
    - job: "Build_Test_FactoryOrchestrator_Service"
      variables: 
        BuildConfiguration: 'Release'
        BuildPlatform: 'AnyCPU'
      steps:
      - checkout: self
      - template: ./templates/template-set-build-version.yml
      - template: ./templates/template-install-netcore.yml
      - powershell: |
          Get-Item -Path env:* | Sort-Object Name
        displayName: "Print all variables"
      - template: ./templates/template-build-test-service.yml
      - template: ./templates/template-build-service-windows-runtimes.yml
      - publish: '$(Build.ARTIFACTSTAGINGDIRECTORY)\bin\$(BuildConfiguration)\$(BuildPlatform)'
        artifact: 'UnsignedBin_Windows_$(BuildConfiguration)_$(BuildPlatform)'
      - template: ./templates/template-checkdocs.yml

    - job: "Build_FactoryOrchestrator_App"
      strategy:
        matrix:
          Release_x86:
            BuildPlatform: 'x86'
            BuildConfiguration: 'Release'
          Release_x64:
            BuildPlatform: 'x64'
            BuildConfiguration: 'Release'
          Release_Arm:
            BuildPlatform: 'ARM'
            BuildConfiguration: 'Release'
        maxParallel: '3'
      steps:
      - checkout: self
      - template: ./templates/template-set-build-version.yml
      - template: ./templates/template-install-netcore.yml
      - powershell: |
          Get-Item -Path env:* | Sort-Object Name
        displayName: "Print all variables"
      - download: current
        artifact: UnsignedBin_Windows_$(BuildConfiguration)_AnyCPU
      - task: CopyFiles@2
        inputs:
          sourceFolder: "$(Pipeline.Workspace)/UnsignedBin_Windows_$(BuildConfiguration)_AnyCPU"
          targetFolder: "$(Build.ARTIFACTSTAGINGDIRECTORY)/bin/$(BuildConfiguration)/AnyCPU"
      - template: ./templates/template-build-app.yml
      - publish: '$(Build.ARTIFACTSTAGINGDIRECTORY)\bin\$(BuildConfiguration)\$(BuildPlatform)'
        artifact: 'UnsignedBin_Windows_$(BuildConfiguration)_$(BuildPlatform)'
        displayName: 'Publish unsigned Windows bin'
      - publish: '$(System.DefaultWorkingDirectory)\src\UWPClientLibrary\obj\$(BuildConfiguration)\*.nuspec'
        artifact: 'UWPClient_Nuspecs'
        displayName: 'Publish unsigned Windows UWPClient nuspecs'
        condition: eq(variables['BuildPlatform'], 'x86')

  - stage: 'Sign_Binaries'
    pool:
      name: "Hosted Windows 2019 with VS2019"
      demands:
      - msbuild
      - visualstudio
    dependsOn:
    - 'Build_Test_FactoryOrchestrator_Windows'
    jobs:
      - job: 'Sign_Windows'
        steps:
        - checkout: ComplianceRepo
          clean: true
        - template: ./templates/template-set-build-version.yml
        - download: current
          artifact: UnsignedBin_Windows*
        - task: CopyFiles@2
          inputs:
            sourceFolder: "$(Pipeline.Workspace)/UnsignedBin_Windows_$(BuildConfiguration)_AnyCPU"
            targetFolder: "$(Build.ARTIFACTSTAGINGDIRECTORY)/unsignedbin/AnyCPU"
        - task: CopyFiles@2
          inputs:
            sourceFolder: "$(Pipeline.Workspace)/UnsignedBin_$(BuildConfiguration)_x86"
            targetFolder: "$(Build.ARTIFACTSTAGINGDIRECTORY)/unsignedbin/x86"
        - task: CopyFiles@2
          inputs:
            sourceFolder: "$(Pipeline.Workspace)/UnsignedBin_$(BuildConfiguration)_x64"
            targetFolder: "$(Build.ARTIFACTSTAGINGDIRECTORY)/unsignedbin/x64"
        - task: CopyFiles@2
          inputs:
            sourceFolder: "$(Pipeline.Workspace)/UnsignedBin_$(BuildConfiguration)_ARM"
            targetFolder: "$(Build.ARTIFACTSTAGINGDIRECTORY)/unsignedbin/ARM"
        - template: ./templates/template-sign-binaries-windows.yml

  - stage: compliance
    displayName: Compliance
    dependsOn:
    - 'Sign_Binaries'
    jobs:
      - job: Compliance_Job
        pool:
          name: Package ES Standard Build
        steps:
        - checkout: self
          clean: true
        
        - checkout: ComplianceRepo
          clean: true
        
        - template: ./templates/template-set-build-version.yml

        - task: PkgESSetupBuild@10
          displayName: 'Package ES - Setup Build'
          inputs:
            branchVersion: true
            branchVersionExcludeBranch: 'main'
            productName: 'FactoryOrchestrator'
            disableOutputRedirect: true
            disableMsbuildVersion: true
            useDfs: false

        - powershell: |
            Get-Item -Path env:* | Sort-Object Name
          displayName: "Print all variables"

        - download: 'current'
          artifact: 'SignedBin_Windows_Release_AllPlatforms'

        - template: assembly-module-compliance.yml@ComplianceRepo
          parameters:
            # binskim
            AnalyzeTarget: '$(Pipeline.Workspace)/SignedBin_Windows_Release_AllPlatforms/**/*.dll;$(Pipeline.Workspace)/SignedBin_Windows_Release_AllPlatforms/**/*.exe'
            AnalyzeSymPath: 'SRV*'
            # component-governance
            sourceScanPath: '$(Build.SourcesDirectory)/src'
            # credscan
            suppressionsFile: 'build/config/CredScanSuppressions.json'
            # TermCheck
            optionsRulesDBPath: ''
            optionsFTPath: ''
            # tsa-upload
            codeBaseName: 'FactoryOrchestrator'
            # API Scan
            softwareFolder: '$(Pipeline.Workspace)/SignedBin_Windows_Release_AllPlatforms'
            softwareName: 'FactoryOrchestrator'
            softwareVersion: '$(VERSIONPREFIX)$(VERSIONSUFFIXVPACK)'
            APIScan: true # set to false when not using Windows APIs.

        - task: PkgESLateTasks@10
          displayName: 'PkgES Finalize and Cleanup'

  - stage: 'Sign_Publish_NuGet'
    dependsOn:
    - 'compliance'
    pool:
      name: "Hosted Windows 2019 with VS2019"
      demands:
      - msbuild
      - visualstudio
    jobs:
      - job: Sign_Publish_NuGet
        steps:
        - checkout: self
          clean: true
        - checkout: ComplianceRepo
          clean: true
        
        - template: ./templates/template-set-build-version.yml
        - template: ./templates/template-install-netcore.yml

        - powershell: |
            Get-Item -Path env:* | Sort-Object Name
          displayName: "Print all variables"

        - download: 'current'
          artifact: 'SignedBin_Windows_Release_AllPlatforms'

        - download: 'current'
          artifact: 'UWPClient_Nuspecs'

        - task: CopyFiles@2
          inputs:
            sourceFolder: "$(Pipeline.Workspace)/SignedBin_Windows_Release_AllPlatforms"
            targetFolder: "$(Build.ARTIFACTSTAGINGDIRECTORY)/bin/Release"

        - template: ./templates/template-sign-publish-nuget.yml

  - stage: 'Publish_vPack'
    dependsOn:
    - 'compliance'
    pool:
      name: Package ES Standard Build
    jobs:
      - job: Publish_vPacks
        steps:
        - checkout: self
          clean: true    

        - task: PkgESSetupBuild@10
          displayName: 'Package ES - Setup Build'
          inputs:
            branchVersion: true
            branchVersionExcludeBranch: 'main'
            productName: 'FactoryOrchestrator'
            disableOutputRedirect: true
            disableMsbuildVersion: true
        
        - template: ./templates/template-set-build-version.yml

        - powershell: |
            Get-Item -Path env:* | Sort-Object Name
          displayName: "Print all variables"

        - download: 'current'
          artifact: 'SignedBin_Windows_Release_AllPlatforms'

        - task: CopyFiles@2
          inputs:
            sourceFolder: "$(Pipeline.Workspace)/SignedBin_Windows_Release_AllPlatforms"
            targetFolder: "$(Build.ARTIFACTSTAGINGDIRECTORY)/bin/Release"

        - template: ./templates/template-publish-vpack-service.yml
          parameters:
            BuildConfiguration: 'Release'
            BuildPlatform: 'x86'
        - template: ./templates/template-publish-vpack-service.yml
          parameters:
            BuildConfiguration: 'Release'
            BuildPlatform: 'x64'
        - template: ./templates/template-publish-vpack-service.yml
          parameters:
            BuildConfiguration: 'Release'
            BuildPlatform: 'arm'
        - template: ./templates/template-publish-vpack-service.yml
          parameters:
            BuildConfiguration: 'Release'
            BuildPlatform: 'arm64'
        - template: ./templates/template-publish-vpack-other.yml

        # Expects ArtifactServices.Symbol.PAT secret variable to be defined with a PAT
        - powershell: |
            $vstsCommandString = "vso[task.setvariable variable=ArtifactServices.Symbol.AccountName]microsoftpublicsymbols"
            Write-Host "sending " + $vstsCommandString
            Write-Host "##$vstsCommandString"
          displayName: 'Set symbol publish variables'

        # Publishes to microsoftpublicsymbols
        - task: PublishSymbols@2
          inputs:
            symbolsFolder: '$(Build.ArtifactStagingDirectory)/bin/'
            indexSources: 'false'
            SymbolServerType: 'teamServices'
            SymbolsArtifactName: 'Symbols_Release_NuGet'
            SymbolsProduct: 'FactoryOrchestrator'
            SymbolsVersion: '$(VersionPrefix)$(VERSIONSUFFIX)'
          condition: and(succeeded(), ne(variables['SKIPPUSH'], 'true'))
          displayName: 'publish symbols to public server'

        - publish: '$(Build.ARTIFACTSTAGINGDIRECTORY)\VPackManifests'
          artifact: VPackManifests
          condition: and(succeeded(), ne(variables['SKIPPUSH'], 'true'))

        - task: PkgESLateTasks@10
          displayName: 'PkgES Finalize and Cleanup'
