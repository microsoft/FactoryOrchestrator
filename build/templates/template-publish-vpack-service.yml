steps:
- task: DotNetCoreCLI@2
  displayName: 'dotnet publish Microsoft.FactoryOrchestrator.Service $(BuildPlatform)'
  inputs:
    command: publish
    publishWebProjects: False
    arguments: '$(Build.SourcesDirectory)\src\Service\Microsoft.FactoryOrchestrator.Service.csproj -p:SolutionDir=$(Build.SourcesDirectory)\src  --configuration $(BuildConfiguration) --output $(Build.ARTIFACTSTAGINGDIRECTORY)\bin\$(BuildConfiguration)\$(BuildPlatform)\Microsoft.FactoryOrchestrator.Service_SCD --self-contained --runtime win-$(BuildPlatform) --verbosity Detailed'
    zipAfterPublish: false
- task: CopyFiles@2
  displayName: 'Copy NOTICE to Drop'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: 'NOTICE.txt'
    TargetFolder: '$(Build.ARTIFACTSTAGINGDIRECTORY)\$(BuildConfiguration)\$(BuildPlatform)\Microsoft.FactoryOrchestrator.Service_SCD'
- task: PowerShell@2
  displayName: 'Create Microsoft.FactoryOrchestrator.Service Manifest for VPack'
  inputs:
    targetType: filePath
    filePath: ./build/internal/CreateServiceManifest.ps1
    arguments: '-PublishFolder "$(Build.ARTIFACTSTAGINGDIRECTORY)\bin\$(BuildConfiguration)\$(BuildPlatform)\Microsoft.FactoryOrchestrator.Service_SCD" -SourceRootFolder "`$(build.nttree)\$NtTreeRootFolder" -OutputFile "$(Build.ARTIFACTSTAGINGDIRECTORY)\bin\$(BuildConfiguration)\$(BuildPlatform)\Microsoft.FactoryOrchestrator.Service_SCD\Microsoft-OneCore-FactoryOrchestrator-Service-$(BuildPlatform).wm.xml" -Owner "Microsoft" -Namespace "OneCore" -Name "FactoryOrchestrator-Service-$(BuildPlatform)" -DestinationRootFolder "`$(runtime.system32)\manufacturing\FactoryOrchestrator'
    failOnStderr: true
  timeoutInMinutes: 5
- task: PkgESVPack@10
  env:
   SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  displayName: 'PkgES Create VPack $(BuildPlatform)'
  inputs:
    sourceDirectory: '$(Build.ARTIFACTSTAGINGDIRECTORY)\bin\$(BuildConfiguration)\$(BuildPlatform)\Microsoft.FactoryOrchestrator.Service_SCD'
    pushPkgName: 'FactoryOrchestrator.Service.$(BuildPlatform)$(VPACKNAME)'
    description: 'FactoryOrchestrator.Service.$(BuildPlatform)$(VPACKNAME)'
    version: '$(VPACKVERSION)'
  condition: and(succeeded(), and(eq(variables['XES_SERIALPOSTBUILDREADY'], 'True'), ne(variables['skipvpack'], 'true')))
  enabled: true
- task: CopyFiles@2
  displayName: 'Copy VPack Manifest to Drop'
  inputs:
    SourceFolder: '$(XES_VPACKMANIFESTDIRECTORY)'
    Contents: '$(XES_VPACKMANIFESTNAME)'
    TargetFolder: '$(XES_DFSDROP)'
  condition: and(succeeded(), and(eq(variables['XES_SERIALPOSTBUILDREADY'], 'True'), ne(variables['skipvpack'], 'true')))
- task: CopyFiles@2
  displayName: 'Copy Artifacts to DFS DROP: $(XES_DFSDROP) - Microsoft.FactoryOrchestrator.Service publish'
  inputs:
    SourceFolder: '$(Build.ARTIFACTSTAGINGDIRECTORY)\'
    TargetFolder: '$(XES_DFSDROP)\'
