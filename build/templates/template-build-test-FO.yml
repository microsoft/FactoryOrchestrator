steps:
    - task: NuGetToolInstaller@0
      displayName: 'Use NuGet 5.7.0'
      inputs:
        versionSpec: 5.7.0
# In the Microsoft Azure DevOps tenant, NuGetCommand is ambiguous.
# This should be `task: NuGetCommand@2`
    - task: DotNetCoreCLI@2
      inputs:
        command: 'restore'
        projects: '$(System.DefaultWorkingDirectory)\src\FactoryOrchestrator.sln'
    - task: VSBuild@1
      displayName: 'Build solution **\*.sln Any CPU'
      inputs:
        platform: 'Any CPU'
        configuration: 'Release'
    - task: VSBuild@1
      displayName: 'Build solution **\*.sln x64'
      inputs:
        platform: x64
        configuration: 'Release'
    - task: VSBuild@1
      displayName: 'Build solution **\*.sln ARM'
      inputs:
        platform: ARM
        configuration: 'Release'
    - task: VSBuild@1
      displayName: 'Build solution **\*.sln x86 and all arch AppXPackage'
      inputs:
        platform: x86
        configuration: 'Release'
        msbuildArgs: '/p:AppxBundlePlatforms="x86|x64|arm" /p:AppxPackageDir="$(build.artifactStagingDirectory)\AppxPackages\\" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=Sideload'
    - task: VSTest@2
      displayName: 'Run UnitTests'
      inputs:
        testAssemblyVer2: |
          bin/Tests/**/*UnitTests.dll
          bin/Tests/**/JKang*Tests.dll
        searchFolder: '$(System.DefaultWorkingDirectory)'
        codeCoverageEnabled: true
        runInParallel: true
        vsTestVersion: latest
        runSettingsFile: '$(System.DefaultWorkingDirectory)\src\Tests\defaults.runsettings'
    - script: |
        cd $(Build.SourcesDirectory)
        pip install --upgrade pip --upgrade -r $(System.DefaultWorkingDirectory)\docs\requirements.txt
        mkdocs build --clean --config-file $(System.DefaultWorkingDirectory)\docs\mkdocs.yml
        git fetch
        git checkout gh-pages
        robocopy $(System.DefaultWorkingDirectory)\docs\site\ $(System.DefaultWorkingDirectory)\ /S
        git restore sitemap.xml*
        git add -A
        git diff --cached --exit-code
        echo ##vso[task.setvariable variable=hasChanges]%errorlevel%
        mkdir $(Build.ArtifactStagingDirectory)\Patch
        git diff --cached > $(Build.ArtifactStagingDirectory)\Patch\UpdatedDocs.patch
      displayName: 'Build and check for changes to website'
    - task: PublishPipelineArtifact@1
      displayName: 'Publish patch file as artifact if website has changes'
      condition: eq(variables['hasChanges'], '1')
      inputs:
        artifactName: UpdatedDocsPatch
        targetPath: $(Build.ArtifactStagingDirectory)\Patch
    - script: |
        echo ##vso[task.logissue type=warning]gh-pages documentation needs updating! Use the published UpdatedDocsPatch artifact to update the gh-pages branch after this PR is completed.
      displayName: 'Warn if website has changes'
      condition: eq(variables['hasChanges'], '1')